{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ribhav/OneDrive/Documents/Projects/Major%20project%20final/localli/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ||\r\n  new PrismaClient({\r\n    log: [\"query\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\")\r\n  globalForPrisma.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCACE,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ribhav/OneDrive/Documents/Projects/Major%20project%20final/localli/src/lib/api.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\n\nexport function jsonError(message: string, status: number) {\n  return NextResponse.json({ error: message }, { status });\n}\n\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,UAAU,OAAe,EAAE,MAAc;IACvD,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAQ,GAAG;QAAE;IAAO;AACxD"}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ribhav/OneDrive/Documents/Projects/Major%20project%20final/localli/src/lib/auth.ts"],"sourcesContent":["import { Role } from \"@prisma/client\";\nimport { NextRequest, NextResponse } from \"next/server\";\nimport jwt, { JwtPayload } from \"jsonwebtoken\";\nimport { jsonError } from \"@/lib/api\";\n\ntype AuthPayload = {\n  userId: number;\n  role: Role;\n};\n\nexport function signToken(payload: AuthPayload) {\n  const jwtSecret = process.env.JWT_SECRET;\n  if (!jwtSecret) {\n    throw new Error(\"JWT_SECRET is required\");\n  }\n\n  return jwt.sign(payload, jwtSecret, { expiresIn: \"7d\" });\n}\n\nfunction getJwtSecret() {\n  return process.env.JWT_SECRET ?? null;\n}\n\nfunction verifyToken(token: string): AuthPayload | null {\n  const jwtSecret = getJwtSecret();\n  if (!jwtSecret) {\n    return null;\n  }\n\n  try {\n    const decoded = jwt.verify(token, jwtSecret) as JwtPayload & Partial<AuthPayload>;\n    if (\n      typeof decoded.userId !== \"number\" ||\n      (decoded.role !== \"CUSTOMER\" && decoded.role !== \"VENDOR\" && decoded.role !== \"ADMIN\")\n    ) {\n      return null;\n    }\n\n    return {\n      userId: decoded.userId,\n      role: decoded.role,\n    };\n  } catch {\n    return null;\n  }\n}\n\nexport function getAuthContext(\n  request: NextRequest\n): { auth: AuthPayload; error: null } | { auth: null; error: NextResponse } {\n  const header = request.headers.get(\"authorization\");\n\n  if (!header || !header.startsWith(\"Bearer \")) {\n    return { auth: null, error: jsonError(\"Unauthorized\", 401) };\n  }\n\n  const token = header.slice(\"Bearer \".length).trim();\n  const auth = verifyToken(token);\n\n  if (!auth) {\n    return { auth: null, error: jsonError(\"Invalid token\", 401) };\n  }\n\n  return { auth, error: null };\n}\n\nexport function requireRole(auth: AuthPayload, role: Role): NextResponse | null {\n  if (auth.role !== role) {\n    return jsonError(\"Forbidden\", 403);\n  }\n\n  return null;\n}\n\nexport function requireAnyRole(auth: AuthPayload, roles: Role[]): NextResponse | null {\n  if (!roles.includes(auth.role)) {\n    return jsonError(\"Forbidden\", 403);\n  }\n\n  return null;\n}\n\nexport type { AuthPayload };\n"],"names":[],"mappings":";;;;;;;;;;AAEA;AACA;;;AAOO,SAAS,UAAU,OAAoB;IAC5C,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU;IACxC,IAAI,CAAC,WAAW;QACd,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,WAAW;QAAE,WAAW;IAAK;AACxD;AAEA,SAAS;IACP,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI;AACnC;AAEA,SAAS,YAAY,KAAa;IAChC,MAAM,YAAY;IAClB,IAAI,CAAC,WAAW;QACd,OAAO;IACT;IAEA,IAAI;QACF,MAAM,UAAU,kJAAG,CAAC,MAAM,CAAC,OAAO;QAClC,IACE,OAAO,QAAQ,MAAM,KAAK,YACzB,QAAQ,IAAI,KAAK,cAAc,QAAQ,IAAI,KAAK,YAAY,QAAQ,IAAI,KAAK,SAC9E;YACA,OAAO;QACT;QAEA,OAAO;YACL,QAAQ,QAAQ,MAAM;YACtB,MAAM,QAAQ,IAAI;QACpB;IACF,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,eACd,OAAoB;IAEpB,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IAEnC,IAAI,CAAC,UAAU,CAAC,OAAO,UAAU,CAAC,YAAY;QAC5C,OAAO;YAAE,MAAM;YAAM,OAAO,IAAA,gIAAS,EAAC,gBAAgB;QAAK;IAC7D;IAEA,MAAM,QAAQ,OAAO,KAAK,CAAC,UAAU,MAAM,EAAE,IAAI;IACjD,MAAM,OAAO,YAAY;IAEzB,IAAI,CAAC,MAAM;QACT,OAAO;YAAE,MAAM;YAAM,OAAO,IAAA,gIAAS,EAAC,iBAAiB;QAAK;IAC9D;IAEA,OAAO;QAAE;QAAM,OAAO;IAAK;AAC7B;AAEO,SAAS,YAAY,IAAiB,EAAE,IAAU;IACvD,IAAI,KAAK,IAAI,KAAK,MAAM;QACtB,OAAO,IAAA,gIAAS,EAAC,aAAa;IAChC;IAEA,OAAO;AACT;AAEO,SAAS,eAAe,IAAiB,EAAE,KAAa;IAC7D,IAAI,CAAC,MAAM,QAAQ,CAAC,KAAK,IAAI,GAAG;QAC9B,OAAO,IAAA,gIAAS,EAAC,aAAa;IAChC;IAEA,OAAO;AACT"}},
    {"offset": {"line": 185, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ribhav/OneDrive/Documents/Projects/Major%20project%20final/localli/src/app/api/checkout/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { getAuthContext, requireRole } from \"@/lib/auth\";\n\nconst INSUFFICIENT_STOCK_ERROR = \"INSUFFICIENT_STOCK\";\n\ntype CheckoutResponse = {\n  id: number;\n  userId: number;\n  total: number;\n  status: string;\n  createdAt: Date;\n  orderItems: Array<{\n    id: number;\n    orderId: number;\n    productId: number;\n    quantity: number;\n    price: number;\n  }>;\n};\n\nexport async function POST(request: NextRequest) {\n  const { auth, error } = getAuthContext(request);\n  if (error) {\n    return error;\n  }\n\n  const roleError = requireRole(auth, \"CUSTOMER\");\n  if (roleError) {\n    return roleError;\n  }\n\n  try {\n    const cartItems = await prisma.cartItem.findMany({\n      where: { userId: auth.userId },\n      select: {\n        id: true,\n        productId: true,\n        quantity: true,\n        product: {\n          select: {\n            id: true,\n            price: true,\n            stock: true,\n          },\n        },\n      },\n    });\n\n    if (cartItems.length === 0) {\n      return NextResponse.json({ message: \"Cart is empty\" }, { status: 400 });\n    }\n\n    const stockIssue = cartItems.find((item) => item.quantity > item.product.stock);\n    if (stockIssue) {\n      return NextResponse.json(\n        { message: `Insufficient stock for product ${stockIssue.product.id}` },\n        { status: 409 }\n      );\n    }\n\n    const total = cartItems.reduce(\n      (sum, item) => sum + item.quantity * item.product.price,\n      0\n    );\n\n    const order = await prisma.$transaction(async (tx): Promise<CheckoutResponse> => {\n      const createdOrder = await tx.order.create({\n        data: {\n          userId: auth.userId,\n          total,\n          status: \"PLACED\",\n        },\n      });\n\n      const orderItems: CheckoutResponse[\"orderItems\"] = [];\n\n      for (const item of cartItems) {\n        const stockUpdate = await tx.product.updateMany({\n          where: {\n            id: item.productId,\n            stock: { gte: item.quantity },\n          },\n          data: {\n            stock: { decrement: item.quantity },\n          },\n        });\n\n        if (stockUpdate.count === 0) {\n          throw new Error(INSUFFICIENT_STOCK_ERROR);\n        }\n\n        const orderItem = await tx.orderItem.create({\n          data: {\n            orderId: createdOrder.id,\n            productId: item.productId,\n            quantity: item.quantity,\n            price: item.product.price,\n          },\n        });\n\n        orderItems.push(orderItem);\n      }\n\n      await tx.cartItem.deleteMany({\n        where: { userId: auth.userId },\n      });\n\n      return {\n        id: createdOrder.id,\n        userId: createdOrder.userId,\n        total: createdOrder.total,\n        status: createdOrder.status,\n        createdAt: createdOrder.createdAt,\n        orderItems,\n      };\n    });\n\n    for (const item of cartItems) {\n      void prisma.interactionLog\n        .create({\n          data: {\n            userId: auth.userId,\n            productId: item.productId,\n            action: \"PURCHASE\",\n          },\n        })\n        .catch(() => {});\n    }\n\n    return NextResponse.json(order, { status: 201 });\n  } catch (checkoutError: unknown) {\n    if (\n      checkoutError instanceof Error &&\n      checkoutError.message === INSUFFICIENT_STOCK_ERROR\n    ) {\n      return NextResponse.json(\n        { message: \"Insufficient stock for one or more products\" },\n        { status: 409 }\n      );\n    }\n\n    return NextResponse.json({ message: \"Checkout failed\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}