{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ribhav/OneDrive/Documents/Projects/Major%20project%20final/localli/src/components/dashboard/map/ClusterHeatmap.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport { CircleMarker, MapContainer, Popup, TileLayer, useMap } from \"react-leaflet\";\nimport L, { type LatLngBoundsExpression } from \"leaflet\";\nimport \"leaflet.heat\";\n\ntype UnifiedCluster = {\n  clusterId: string;\n  currentDemandScore: number;\n  previousDemandScore: number;\n  growthRate: number;\n  isSurging: boolean;\n  competitionIndex: number;\n  opportunityScore: number;\n  latitude: number;\n  longitude: number;\n};\n\ninterface ClusterHeatmapProps {\n  days: number;\n  onMarkerClick?: (cluster: UnifiedCluster) => void;\n}\n\ntype HeatPoint = [number, number, number];\n\nconst DEFAULT_CENTER: [number, number] = [20.5937, 78.9629];\nconst DEFAULT_ZOOM = 5;\n\nexport default function ClusterHeatmap({ days, onMarkerClick }: ClusterHeatmapProps) {\n  const [clusters, setClusters] = useState<UnifiedCluster[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    let isMounted = true;\n\n    async function fetchMapData() {\n      try {\n        setLoading(true);\n        const res = await fetch(`/api/analytics/cluster-intelligence?days=${days}`);\n        if (!res.ok) {\n          throw new Error(\"Failed to fetch map data\");\n        }\n\n        const data = await res.json();\n        if (!isMounted) {\n          return;\n        }\n\n        setClusters(Array.isArray(data.clusters) ? data.clusters : []);\n        setError(null);\n      } catch {\n        if (!isMounted) {\n          return;\n        }\n\n        setError(\"Failed to load map data\");\n      } finally {\n        if (isMounted) {\n          setLoading(false);\n        }\n      }\n    }\n\n    fetchMapData();\n\n    return () => {\n      isMounted = false;\n    };\n  }, [days]);\n\n  const validClusters = useMemo(\n    () => clusters.filter((c) => Number.isFinite(c.latitude) && Number.isFinite(c.longitude)),\n    [clusters]\n  );\n\n  const maxDemand = useMemo(\n    () =>\n      validClusters.reduce((max, cluster) => Math.max(max, cluster.currentDemandScore), 0) || 1,\n    [validClusters]\n  );\n\n  const heatPoints = useMemo<HeatPoint[]>(\n    () =>\n      validClusters.map((cluster) => [\n        cluster.latitude,\n        cluster.longitude,\n        Math.max(0.1, cluster.currentDemandScore / maxDemand),\n      ]),\n    [maxDemand, validClusters]\n  );\n\n  const bounds = useMemo<LatLngBoundsExpression | null>(() => {\n    if (validClusters.length === 0) {\n      return null;\n    }\n\n    return validClusters.map((cluster) => [cluster.latitude, cluster.longitude]);\n  }, [validClusters]);\n\n  if (loading) {\n    return (\n      <div className=\"flex h-72 items-center justify-center rounded-xl border border-dashed border-zinc-700\">\n        <span className=\"text-sm text-zinc-500\">Loading map...</span>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"flex h-72 items-center justify-center rounded-xl border border-dashed border-zinc-700\">\n        <span className=\"text-sm text-[#FF453A]\">{error}</span>\n      </div>\n    );\n  }\n\n  if (validClusters.length === 0) {\n    return (\n      <div className=\"flex h-72 items-center justify-center rounded-xl border border-dashed border-zinc-700\">\n        <span className=\"text-sm text-zinc-500\">No clusters available for this period</span>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-72 overflow-hidden rounded-xl border border-zinc-800\">\n      <MapContainer\n        center={DEFAULT_CENTER}\n        className=\"h-full w-full\"\n        scrollWheelZoom={false}\n        zoom={DEFAULT_ZOOM}\n      >\n        <TileLayer\n          attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\n          url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n        />\n\n        <HeatLayer\n          max={1}\n          points={heatPoints}\n          radius={Math.max(18, Math.min(40, 20 + validClusters.length / 2))}\n        />\n\n        {bounds ? <FitToBounds bounds={bounds} /> : null}\n\n        {validClusters.map((cluster) => (\n          <CircleMarker\n            center={[cluster.latitude, cluster.longitude]}\n            eventHandlers={{\n              click: () => onMarkerClick?.(cluster),\n            }}\n            key={cluster.clusterId}\n            pathOptions={{\n              color: \"#4F7CFF\",\n              fillColor: \"#4F7CFF\",\n              fillOpacity: 0.7,\n            }}\n            radius={4}\n          >\n            <Popup>\n              <div className=\"text-xs text-zinc-900\">\n                <p>\n                  <strong>Cluster:</strong> {cluster.clusterId}\n                </p>\n                <p>\n                  <strong>Demand:</strong> {cluster.currentDemandScore.toFixed(2)}\n                </p>\n                <p>\n                  <strong>Opportunity:</strong> {cluster.opportunityScore.toFixed(2)}\n                </p>\n                <p>\n                  <strong>Competition:</strong> {cluster.competitionIndex.toFixed(2)}\n                </p>\n              </div>\n            </Popup>\n          </CircleMarker>\n        ))}\n      </MapContainer>\n    </div>\n  );\n}\n\ninterface HeatLayerProps {\n  points: HeatPoint[];\n  radius: number;\n  max: number;\n}\n\nfunction HeatLayer({ points, radius, max }: HeatLayerProps) {\n  const map = useMap();\n\n  useEffect(() => {\n    if (points.length === 0) {\n      return;\n    }\n\n    const layer = (L as unknown as { heatLayer: (p: HeatPoint[], o: object) => L.Layer }).heatLayer(\n      points,\n      {\n        radius,\n        blur: 20,\n        max,\n        minOpacity: 0.35,\n        gradient: {\n          0.2: \"#1D4ED8\",\n          0.5: \"#4F7CFF\",\n          0.7: \"#30D158\",\n          1.0: \"#FF453A\",\n        },\n      }\n    );\n\n    layer.addTo(map);\n    return () => {\n      map.removeLayer(layer);\n    };\n  }, [map, max, points, radius]);\n\n  return null;\n}\n\ninterface FitToBoundsProps {\n  bounds: LatLngBoundsExpression;\n}\n\nfunction FitToBounds({ bounds }: FitToBoundsProps) {\n  const map = useMap();\n\n  useEffect(() => {\n    map.fitBounds(bounds, { padding: [24, 24], maxZoom: 12 });\n  }, [bounds, map]);\n\n  return null;\n}\n"],"names":[],"mappings":"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"}}]
}